---
title: "Template for PWQN Monthly Invoice"
author: "ROSSyndicate - Sam Struthers"
date: "`r Sys.Date()`"
output: word_document
---

# User Inputs Required

-   Update `mWater_API_placeholder` to have the correct API url and rename the file to `mWater_API.yml`
-   Have Katie Willi or Matt Ross run the `budget_downloader.Rmd` script to get up to date job code data
-   Change the month and year in the chunk below to the month you are looking for

Once these are done, you can go to the section "Run Above..." to tidy data for user review

```{r}
###### ------ MONTH AND YEAR SELECTOR ------ ######
month_select <- 7
year_select <- 2025
```

# Setup
```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#load packages
package_loader <- function(x) {
  if (x %in% installed.packages()) {
    library(x, character.only = TRUE)
  } else {
    install.packages(x)
    library(x, character.only = TRUE)
  }
}
lapply(c("tidyverse", "readxl", "arrow", "flextable", "officer", "yaml"), package_loader)
rm(package_loader)
# get wd
dir <- getwd()

#load functions
source(paste0(dir,"/src/grab_mWater_sensor_notes.R"))
source(paste0(dir,"/src/load_mWater_notes.R"))

# Read in credentials
mWater_creds <- read_yaml(here("creds", "mWaterCreds.yml"))

`%nin%` = Negate(`%in%`)



```


# Tidy up personnel budget

Update with new staff/salaries at the start of each year

```{r tidy_personnel, echo=FALSE, message=FALSE}

###### ----- HOURLY RATES ------ #######
#      UPDATE AS NEEDED               #
hourly_rates <- read_csv(file = paste0(dir,"/data/sharing/budget/employee_hourly_rates.csv"), show_col_types = F)%>%
  mutate(fringe = case_when(type == "Salary" ~ .286, 
                            type == "Hourly" ~ .012), 
    hourly_n_fringe = case_when(type == "Salary" ~ (rate) / 1230 , 
                                   type == "Hourly" ~  rate),
    hourly_billed = case_when(type == "Salary" ~ (rate + (rate * fringe)) / 1230 , 
                                   type == "Hourly" ~  rate + (rate* fringe)))

# Pull in personnel budget
senior_staff <- read_excel(path = paste0(dir,"/data/sharing/budget/pwqn_budget_reporting.xlsx"), sheet = "staff_timeclock")%>%
  mutate(month = month(date), 
         year = year(date))%>%
  # filter for months and year selected above and pwqn project
  filter(month == month_select & year == year_select & project == "PWQN")%>%
  group_by(category, staff, Extension) %>%
  # combine unique descriptions and sum hours for each category
  summarize(description = paste(unique(description), collapse = ", "), hours = sum(hours))%>%
  ungroup()%>%
  # add in the hourly rates for senior staff
  left_join(select(hourly_rates, person, hourly_billed), by = c("staff" = "person"))%>%
  # calculate hourly costs and hours rate
mutate(hourly_billed = round(hourly_billed, 2),
      hours_rate = paste0(hours, " x $", hourly_billed, "/hr"),
      cost = round(hours * hourly_billed, 2), 
      #define it as in kind or Yes if not in kind
      include = case_when(category %in% c("Code", "QAQC") ~ "No",
                          #remove staff/intern time paid for by Extension
                          Extension == TRUE ~ "No",
                          TRUE ~ "Yes"))%>%
  # remove hours and hourly billed (summarized in hours_rate)
  select(-hours, -hourly_billed)
```


```{r tidy_equip_travel, echo=FALSE, message=FALSE}

# Pull in equipment budget

equipment <- read_excel(path = paste0(dir,"/data/sharing/budget/pwqn_budget_reporting.xlsx"), sheet = "equipment_charges")%>%
  mutate(month = month(date), 
         year = year(date))%>%
  # filter for months and year selected above and pwqn project
  filter(month == month_select & year == year_select & project == "PWQN")%>%
  mutate(category = "Equipment", 
         include = ifelse(startup == T, "No", "Yes"))%>%
  select(category, 
         staff = vendor, 
         description = item,
         cost = amount, 
         include)%>%
  #set include to character
  mutate(include = as.character(include))

# Pull in travel budget

travel <- read_excel(path = paste0(dir,"/data/sharing/budget/pwqn_budget_reporting.xlsx"), sheet = "travel")%>%
  mutate(month = month(date), 
         year = year(date))%>%
  # filter for months and year selected above and pwqn project
  filter(month == month_select & year == year_select & project == "PWQN")%>%
  mutate(category = "Travel", 
         include = ifelse(startup == T, "No", "Yes"))%>%
  select(category,
         description,
         cost = amount, 
         include)%>%
  #set include to character
  mutate(include = as.character(include))
  
```
# Summarize Field Notes

```{r summarize_field_notes, include=FALSE, echo=FALSE}

# Pull in field notes from mWater subset to month selected and grab the calibration dates and site visits
grab_monthly_notes <- function(full = F){
  
# Pulling in the data from mWater
mWater_data <- load_mWater_notes(creds = mWater_creds)

field_notes <- grab_mWater_sensor_notes(mWater_api_data = mWater_data)%>%
  #fix dates
  mutate(date = as.Date(date),
    month = month(date),
         year = year(date),
         site = tolower(site))%>%
  #filter for PWQN sites and the month and date desired
  filter(site %in% c("bellvue", "salyer", "udall","riverbend","cottonwood", "elc", "archery", "riverbluffs") & month == month_select & year == year_select)%>%
  #filter(site %in% c("tamasag", "legacy", "lincoln","timberline","prospect",  "boxelder", "archery", "riverbluffs") & month == month_select & year == year_select)%>% 
  select(-rdo_cap_condition, -rdo_cap_replaced, -photos_downloaded, -sonde_employed, -wiper_working, -ph_junction_replaced, 
         -last_site_visit, -sensor_pulled, -sensor_deployed, -month, -year, -field_season, -end_dt, -DT_join, -start_DT, -sensor_swapped_notes, -start_time_mst, -cal_report_collected)

#find number of site visits
  monthly_visits <- field_notes%>%
    group_by(site)%>%
    summarise(visits = n())
    
  #find all the calibration dates for each site
  cal_dates <-field_notes%>%
    #filter out the "none" calibrations
    filter(!grepl("none", cals_performed, ignore.case = TRUE))%>%
    #filter out the NA's
    filter(!is.na(cals_performed))%>%
    select(date, site, cals_performed)%>%
    #get a shorter date
    mutate(date_mmdd = format(date, "%m/%d"))%>%
    group_by(site)%>%
    summarise(cal_dates = paste(date_mmdd, collapse = ", "))
  
  #combine cal dates and monthly visits
  notes_final <- tibble(site =  c("bellvue", "salyer", "udall","riverbend","cottonwood",  "elc", "archery", "riverbluffs") )%>%
    left_join(monthly_visits, by = c("site"))%>%
    left_join(cal_dates, by = c("site"))%>%
    # if site visits is NA, make it 0
    mutate(`Site Visits` = ifelse(is.na(visits), 0, visits),
           # if cal dates is NA, make it "None"
           `Calibration Dates` = ifelse(is.na(cal_dates), "None", cal_dates),
           # fix site names to be cleaner
           Site = case_when(site == "riverbluffs" ~ "River Bluffs", 
                            site == "elc" ~ "ELC",
                            TRUE ~ str_to_title(site)),
           Site = factor(Site, levels = c("Bellvue", "Salyer", "Udall","Riverbend","Cottonwood",  "ELC", "Archery", "River Bluffs") ))%>%
    #arrange upstream to downstream
    arrange(Site)%>%
    #select only the needed columns
    select(Site,`Site Visits`,`Calibration Dates`)
  
  if(full == T){
    return(field_notes)
  }else if(full == F){
    return(notes_final)
  }
  }

field_summary <- grab_monthly_notes(full = F)

# If additional review is needed, full notes available for review
all_field_notes <- grab_monthly_notes(full = T)%>%
  arrange(site, DT_round)

# write field notes summary to csv for 02 script
write_csv(field_summary, paste0(dir, "/data/sharing/budget/field_summary/field_summary_",month_select, "_", year_select,".csv"))


rm(grab_monthly_notes)
rm(grab_mWater_sensor_notes)
print("Field Summary Complete and Job Code Data tidied")
```

# Run Above to Tidy data for selected month

```{r}

```

# Organize final data for PWQN monthly invoices

```{r final_data, echo=FALSE, message=FALSE}
#create order for categories for table
category_order <- c("Field", "Equipment","Travel", "Admin","Annual Report", "QAQC")

# combine all data
all_data <- senior_staff %>%
  #join all staff charges with equipment and travel charges
  bind_rows(equipment)%>%
  bind_rows(travel)%>%
  #arrange by category order
  arrange(factor(category, levels = category_order))%>%
  mutate(staff = str_to_title(tolower(staff)))%>% # make first letter of staff/vendor person name capital then the rest to lower
  rename(Category = category, `Staff or Vendor` = staff, 
         Description = description, `Hours x Rate (if applicable)` = hours_rate, Cost = cost)
#view all data
print(all_data)
```

# Write to CSV for 02 script
```{r}

# write to csv for 02 script
write_csv(all_data, paste0(dir,"/data/sharing/budget/charges_final/charges_final_", month_select, "_", year_select,  ".csv"))

#clear all environment
rm(list = ls())
```

